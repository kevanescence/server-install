---
      
- name: Installing packages
  hosts: all
  tasks:
  - name: Install package https provider
    package:
      name: apt-transport-https
      state: latest
    become: yes

  - name: install some packages
    package:
      name: "{{ item }}"
      state: latest
    with_items:
      - curl
      - git
      - apache2
      - openjdk-8-jdk
      - python
      - python-apt
      - python3-apt
      - python-pip
      - virtualenv
      - mysql-client
      - default-libmysqlclient-dev
    become: yes


- name: Install docker
  hosts: all
  tasks:
    - name: "Add docker hug gpg key"
      apt_key:
        url: https://download.docker.com/linux/debian/gpg
        state: present
      become: yes

    - name: "Add dockerhub repository"
      apt_repository: 
        repo: deb [arch=amd64] https://download.docker.com/linux/debian/ stretch stable
        state: present
      become: yes
    
    - name: "Install docker"
      package: 
        name: docker-ce
        state: present
      become: yes
  
- name: Installing jenkins
  hosts: all
  vars:
    jenkins_version: '2.92'
    jenkins_package_state: "present"
    jenkins_http_port: 9180
    jenkins_admin_username: 'kevanescence'
    jenkins_admin_password: 'kevanescence'
    jenkins_plugins: ["cloverphp", "cobertura", "docker-workflow", "embeddable-build-status", "jdepend", "analysis-collector", "xunit", "violations"]
  roles:
    - role: geerlingguy.jenkins
      become: true

- name: Initialization of services hosted by docker
  hosts: all
  tasks:
    - name: "Installing required packages for services creation (pip)"
      pip:
        name: "{{ item }}"
      with_items:
        - docker-py
        - MySQL-python
      become: yes

    - name: "Downloaded docker images"
      docker_image:
        name: "{{ item }}"
      with_items:
        - selenium/hub
        - linuxserver/piwigo
        - owncloud
      become: yes

    - name: "Creating selenium hub container"
      docker_container:
        name: selenium-hub
        image: selenium/hub
        state: started
        recreate: yes
        restart: yes
        published_ports:
          - "4444:4444"
      become: yes

    - user: 
        name: service-mysql
        comment: "Mysql service user"
        uid: 1041
      become: yes
    - name: "Creating a mysql container"
      docker_container:
        name: mysql
        image: mysql
        state: started
        recreate: yes
        restart: yes
        env:
            MYSQL_ROOT_PASSWORD: secret_pwd
        published_ports:
          - "3306:3306"
      become: yes

    - user: 
        name: service-photos
        comment: "Piwigo service user"
        uid: 1040
      become: yes

    - mysql_db:
        login_host: 127.0.0.1
        login_user: root
        login_password: secret_pwd
        login_port: 3306
        name: service-photos
        state: present
    - name: "Creating piwigo container"
      docker_container:
        name: photos-server
        image: linuxserver/piwigo
        state: started
        recreate: yes
        restart: yes
        env:
            PGID: 1040
            PUID: 1040
            TZ: "UTC"
        links:
          - "mysql:piwigo_mysql"
        published_ports:
          - "8010:80"
        volumes:
          - /home/service-photos/data:/config
          - /etc/localtime:/etc/localtime:ro 
      become: yes

    - name: "Creating owncloud container"
      docker_container:
        name: storage-server
        image: owncloud
        state: started
        recreate: yes
        restart: yes
        published_ports:
          - "8011:80"
      become: yes

